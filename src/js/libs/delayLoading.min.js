var $window = $(window);
$.grep = function (elems, callback, inv) {
    var retVal,
        ret = [],
        i = 0,
        length = elems.length;
    inv = !!inv;

    // Go through the array, only saving the items
    // that pass the validator function
    for (; i < length; i++) {
        retVal = !!callback(elems[i], i);
        if (inv !== retVal) {
            ret.push(elems[i]);
        }
    }

    return ret;
};
$.each({
    // fadeIn: {
    //     opacity: "1"
    // }
}, function (name, props) {
    $.fn[name] = function (speed, easing, callback) {
        this.css({
            display: 'block',
            opacity: "0"
        });
        return this.animate(props, speed, easing, callback);
    };
});
$.fn.lazyload = function (options) {
    var elements = this;
    var $container;
    var settings = {
        threshold: 0,
        failure_limit: 0,
        event: "scroll",
        effect: "fadeIn",
        container: window,
        data_attribute: "original",
        data_attribute_retina: "original-retina",
        skip_invisible: true,
        appear: null,
        load: null,
        placeholder: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC"
    };

    function update() {
        var counter = 0;

        elements.each(function () {
            var $this = $(this);
                    if (settings.skip_invisible && !$this.is(":visible")) {
                        return;
                    }
            if ($.abovethetop(this, settings) ||
                $.leftofbegin(this, settings)) {
                /* Nothing. */
            } else if (!$.belowthefold(this, settings) &&
                !$.rightoffold(this, settings)) {
                $this.trigger("appear");
                /* if we found an image we'll load, reset the counter */
                counter = 0;
            } else {
                if (++counter > settings.failure_limit) {
                    return false;
                }

            }
        });

    }

    if (options) {
        /* Maintain BC for a couple of versions. */
        if (undefined !== options.failurelimit) {
            options.failure_limit = options.failurelimit;
            delete options.failurelimit;
        }
        if (undefined !== options.effectspeed) {
            options.effect_speed = options.effectspeed;
            delete options.effectspeed;
        }

        $.extend(settings, options);
    }

    /* Cache container as jQuery as object. */
    $container = (settings.container === undefined ||
        settings.container === window) ? $window : $(settings.container);

    /* Fire one scroll event per scroll. Not one scroll event per image. */
    if (0 === settings.event.indexOf("scroll")) {
        $container.bind(settings.event, function () {
            return update();
        });
    }

    this.each(function () {
        var self = this;
        var $self = $(self);

        self.loaded = false;  

        /* If no src attribute given use data:uri. */
        if ($self.attr("src") === undefined || $self.attr("src") === false) {
            if ($self.is("img")) {
                // $self.attr("src", settings.placeholder);
            }
        }
        // console.log($(self))

        /* When appear is triggered load original image. */
        $self.one("appear", function () {
            if (!this.loaded) {
                if (settings.appear) {
                    console.log('settings.appear', settings.appear)
                    var elements_left = elements.length;
                    settings.appear.call(self, elements_left, settings);
                }
                if($self.attr('src')) return;
                $("<img />")
                    .bind("load", function () {
                        var original = $self.attr("data-" + settings.data_attribute_retina) || $self.attr("data-" + settings.data_attribute);
                        $self.hide();
                        if ($self.is("img")) {
                            $self.attr("src", original);
                        } else {
                            $self.css("background-image", "url('" + original + "')");
                            $self.css({
                                "background-size": "100% auto",
                                "-webkit-background-size": "100% auto",
                                "-moz-background-size": "100% auto",
                                "background-color": "transparent"
                            });
                        }
                        $self[settings.effect](settings.effect_speed);

                        self.loaded = true;

                        /* Remove image from array so it is not looped next time. */
                        var temp = $.grep(elements, function (element) {
                            return !element.loaded;
                        });
                        elements = $(temp);

                        if (settings.load) {
                            var elements_left = elements.length;
                            settings.load.call(self, elements_left, settings);
                        }
                    })
                    .bind('error', function () {
                        $self.trigger('error');
                    })
                    .attr("src", $self.attr("data-" + settings.data_attribute));
            }
        });

        /* When wanted event is triggered load original image */
        /* by triggering appear.                              */
        if (0 !== settings.event.indexOf("scroll")) {
            $self.bind(settings.event, function () {
                if (!self.loaded) {
                    $self.trigger("appear");
                }
            });
        }
    });

    /* Check if something appears when window is resized. */
    $window.bind("resize", function () {
        update();
    });

    /* With IOS5 force loading images when navigating with back button. */
    /* Non optimal workaround. */
    if ((/(?:iphone|ipod|ipad).*os 5/gi).test(navigator.appVersion)) {
        $window.bind("pageshow", function (event) {
            if (event.originalEvent && event.originalEvent.persisted) {
                elements.each(function () {
                    $(this).trigger("appear");
                });
            }
        });
    }

    /* Force initial check if images should appear. */
    $(document).ready(function () {
        update();
    });

    return this;
};

/* Convenience methods in jQuery namespace.           */
/* Use as  $.belowthefold(element, {threshold : 100, container : window}) */

$.belowthefold = function (element, settings) {

    var fold;

    if (settings.container === undefined || settings.container === window) {

        fold = (window.innerHeight ? window.innerHeight : $window.height()) + window.scrollY;
        //fold = (window.innerHeight ? window.innerHeight : $window.height()) + $window.scrollTop();
    } else {

        fold = $(settings.container).offset().top + $(settings.container).height();
    }

    return fold <= $(element).offset().top - settings.threshold;
};

$.rightoffold = function (element, settings) {};

$.abovethetop = function (element, settings) {
    var fold;

    if (settings.container === undefined || settings.container === window) {
        fold = window.scrollY;
        //fold = $window.scrollTop();
    } else {
        fold = $(settings.container).offset().top;
    }

    return fold >= $(element).offset().top + settings.threshold + $(element).height();
};

$.leftofbegin = function (element, settings) {};

$.inviewport = function (element, settings) {
    return !$.rightoffold(element, settings) && !$.leftofbegin(element, settings) &&
        !$.belowthefold(element, settings) && !$.abovethetop(element, settings);
};
// (function ($) {
//     $.fn.lazyload = function (options) {
//         var settings = {
//             threshold: 0,
//             failurelimit: 0,
//             event: "scroll",
//             effect: "show",
//             container: window
//         };
//         if (options) {
//             $.extend(settings, options);
//         }
//         var elements = this;
//         if ("scroll" == settings.event) {
//             $(settings.container).bind("scroll", function (event) {
//                 var counter = 0;
//                 elements.each(function () {
//                     if ($.abovethetop(this, settings)) {
//                         self.loaded = false;
//                     } else if (!$.belowthefold(this, settings)) {
//                         self.loaded = false;
//                         $(this).trigger("appear");
//                     } else {
//                         self.loaded = true;
//                         if (counter++ > settings.failurelimit) {
//                             return false;
//                         }
//                     }
//                 });
//                 var temp = $.grep(elements, function (element) {
//                     return !element.loaded;
//                 });
//                 elements = $(temp);
//             });
//         }
//         this.each(function () {
//             var self = this;
            
//             $(self).one("appear", function () {
//                 if (!this.loaded) {
//                     $("[class*=lazy]").bind("load", function () {
//                         $(self).hide().attr("src", $(self).attr("data-original"))[settings.effect](settings.effectspeed);
//                         self.loaded = true;
//                     }).attr("src", $(self).attr("data-original"));
//                 };
//             });
//             if ("scroll" != settings.event) {
//                 $(self).bind(settings.event, function (event) {
//                     if (!self.loaded) {
//                         $(self).trigger("appear");
//                     }
//                 });
//             }
//         });
//         $(settings.container).trigger(settings.event);
//         return this;
//     };
//     $.belowthefold = function (element, settings) {
//         if (settings.container === undefined || settings.container === window) {
//             var fold = $(window).height() + $(window).scrollTop();
//         } else {
//             var fold = $(settings.container).offset().top + $(settings.container).height();
//         }
//         return fold <= $(element).offset().top - settings.threshold;
//     };
//     $.rightoffold = function (element, settings) {
//         if (settings.container === undefined || settings.container === window) {
//             var fold = $(window).width() + $(window).scrollLeft();
//         } else {
//             var fold = $(settings.container).offset().left + $(settings.container).width();
//         }
//         return fold <= $(element).offset().left - settings.threshold;
//     };
//     $.abovethetop = function (element, settings) {
//         if (settings.container === undefined || settings.container === window) {
//             var fold = $(window).scrollTop();
//         } else {
//             var fold = $(settings.container).offset().top;
//         }
//         return fold >= $(element).offset().top + settings.threshold + $(element).height();
//     };
//     $.leftofbegin = function (element, settings) {
//         if (settings.container === undefined || settings.container === window) {
//             var fold = $(window).scrollLeft();
//         } else {
//             var fold = $(settings.container).offset().left;
//         }
//         return fold >= $(element).offset().left + settings.threshold + $(element).width();
//     };
//     $.extend($.expr[':'], {
//         "below-the-fold": "$.belowthefold(a, {threshold : 0, container: window})",
//         "above-the-fold": "!$.belowthefold(a, {threshold : 0, container: window})",
//         "right-of-fold": "$.rightoffold(a, {threshold : 0, container: window})",
//         "left-of-fold": "!$.rightoffold(a, {threshold : 0, container: window})"
//     });
// })(jQuery);






//Brand loading 懒加载 （DOM为父级ID）

function brandLoading(dom) {
    
    this.$dom = dom;
    this.$listCont = this.$dom.find('.option  .list_cont');
    this.bindEvent(); //初始化
    this.int();
}
brandLoading.prototype = {
    //初始化方法
    int: function () {
        var _this = this;
        setTimeout(function () {
            _this.$listCont.find('img').each(function () {
                if (_this.checkShow($(this)) && !_this.isLoaded($(this))) {
                    _this.loadImg($(this));
                }
            })
        }, 200)
    },
    //滚动事件和click
    bindEvent: function () {
        //为了不在滚轮滚动过程中就一直判定，设置个setTimeout,等停止滚动后再去判定是否出现在视野中。
        var clock; //这里的clock为timeID，
        var _this = this;
        $(this.$listCont).on('scroll', function () {
            _this.lazyRender();
            if (clock) { // 如果在300毫秒内进行scroll的话，都会被clearTimeout掉，setTimeout不会执行。
                //如果有300毫秒外的操作，会得到一个新的timeID即clock，会执行一次setTimeout,然后保存这次setTimeout的ID，
                //对于300毫秒内的scroll事件，不会生成新的timeID值，所以会一直被clearTimeout掉，不会执行setTimeout.
                clearTimeout(clock);
            }
            clock = setTimeout(function () {
                _this.lazyRender();
            }, 300);
        })
    },
    //滚动个距离
    checkShow: function ($img) {
        var scrollTop = $(window).scrollTop(); //即页面向上滚动的距离
        var windowHeight = $(window).height(); // 浏览器自身的高度
        var offsetTop = $img.offset().top; //目标标签img相对于document顶部的位置
        if (offsetTop < (scrollTop + windowHeight) && offsetTop > scrollTop) { //在2个临界状态之间的就为出现在视野中的
            return true;
        }
        return false;
    },
    //赋值
    isLoaded: function ($img) {
        return $img.attr('data-src') === $img.attr('src'); //如果data-src和src相等那么就是已经加载过了
    },
    //赋值给src
    loadImg: function ($img) {
        $img.attr('src', $img.attr('data-src')); // 加载就是把自定义属性中存放的真实的src地址赋给src属性
    },
    //滚动加载
    lazyRender: function () {
        var _this = this;
        _this.$listCont.find('img').each(function () {
            if (_this.checkShow($(this)) && !_this.isLoaded($(this))) {
                _this.loadImg($(this));
            }
        })
    },
}

window.arandLoading = brandLoading;
